---
title: "Bowen Biodiversity SDMs"
author: "Jay Matsushiba"
date: "2024-12-11"
output: "html_document"
---

# Creating Bowen Biodiversity SDMs
This document shows the process for creating the Bowen Biodiversity SDMs.
- SDMs have been cropped to Bowen Island shoreline extent. 
- SDMs extrapolated to full Bowen Island extent where missing values, using weighted mean moving window algorithm (terra::focal()) 
- SDMs smoothed using weighted mean moving window algorithm

```{r setup}
# Internal packages developed / modified by Jay Matsushiba
library(sdmcsr)
library(rinat)
# CRAN packages
library(tidyverse)
library(terra)
library(sf)

# # Min SDM cell value somewhere on Bowen Island for including species into focal list.
# include_threshold <- 0.5  
# # Min SDM cell value for a given cell for species to be considered present.
# present_threshold <- 0.7
```

```{r sdm}
# Focal species
SDM_obs_df <- read.csv("ProcessedData/2024_12_10_SDM_CS_all_species.csv")

# Prepare SDM stack
SDM_stack <- list()

# Defining CRS to make sure all SDMs have the same
the_crs <- "+proj=aea +lat_0=45 +lon_0=-126 +lat_1=50 +lat_2=58.5 +x_0=1000000 +y_0=0 +ellps=GRS80 +towgs84=0,0,0,0,0,0,0 +units=m +no_defs"

# Bowen Shoreline polygon for masking the rasters 
bowen_shoreline <- terra::vect("RawData/shoreline_dem_smoothed2/shoreline_dem_smoothed2.shp") %>%
  terra::project(the_crs)

# Weights for terra::focal() function that provides moving window average
## - Smoothing algorithm essentially
## - Use this to fill some empty cells on Bowen Island with weighted mean of the 
##   neighbouring cells. 
weights <- matrix(c(0, 0, 1, 1, 1, 0, 0,
                    0, 1, 1, 2, 1, 1, 0,
                    1, 1, 3, 3, 3, 1, 1,
                    1, 2, 3, 5, 3, 2, 1,
                    1, 1, 3, 3, 3, 1, 1,
                    0, 1, 1, 2, 1, 1, 0,
                    0, 0, 1, 1, 1, 0, 0
), nrow=7)

# Looping through SDMs to prepare as raster stack
for(i in 1:length(SDM_obs_df$filepath)) {
  SDM <- terra::rast(SDM_obs_df$filepath[i]) %>%
    terra::project(y = the_crs) %>%
    # Fills the NA values missing in south part of Bowen Island
    terra::focal(w = weights, 
                 fun = "mean",
                 na.policy = "only") %>%
    # Downsamples from 400 m to 100 m resolution
    terra::disagg(fact = 4) %>%
    # Smooths the raster
    terra::focal(w = weights,
                 fun = "mean",
                 na.policy = "omit") %>%
    terra::mask(bowen_shoreline)
  SDM_stack[[i]] <- SDM
}
SDM_stack <- SDM_stack %>%
  terra::rast()

# Plot to check resulting raster stack
SDM_stack %>% sum(na.rm = T) %>% plot()

SDM_stack_paths <- SDM_obs_df$filepath %>%
  gsub("RawData/2024_11_28_SDM_Bowen_Island", "ProcessedData/2024_12_11_SDM_100m_Bowen_Island", .) %>%
  gsub("_NAs_pu_mask", "_BowenIsland_100m", .)

SDM_stack_directories <- SDM_stack_paths %>%
  dirname() %>%
  unique()

for(dir in 1:length(SDM_stack_directories)) {
  if(!dir.exists(SDM_stack_directories[dir])) {
    dir.create(SDM_stack_directories[dir],
               recursive = T)
  }
}

writeRaster(SDM_stack, SDM_stack_paths)
```

